
@{
    ViewBag.Title = "OutLet";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="wrap">
    <div class="pg-header jarallax overlay parlx-pad sec-mar">
        <img class="jarallax-img" src="~/Content/images/page-title.jpg" alt="">
        <div class="container">
            <div class="row">
                <h1 hidden>Category</h1>
                <div class="col-md-12 col-sm-12 text-center">
                    <ul class="breadcrumb dir" id="Group">
                        <li><a href=@Url.Action(MVC.Home.Index())>صفحه اصلی</a></li>
                        <li class="active">
                          اوتلت
                        </li>

                    </ul>
                </div>
            </div>
        </div>
    </div>
    <main class="main">
        <div class="container">
            <div class="row sec-mar">
                <div class="col-md-3 col-sm-3 sidebar dirfloat">
                    <div class="sidebar_widget">
                        <div class="widget_title"><h4 class="dir">برند</h4></div>
                        <input style="margin-bottom:20px;" id="myInput" class="search dir" type="search" placeholder="جستجو براساس برند" />
                        <ul class="detail-cat" id="myList"></ul>
                    </div>
                    <!--category-->
                    <div class="sidebar_widget price-filter">
                        <div class="widget_title"><h4 class="dir">محدوده قیمت(ریال)</h4></div>
                        <div id="price-range"></div>
                        <input type="hidden" id="amount1">
                        <input type="hidden" id="amount2">
                        <div class="range-bottom">
                            <div id="amount"></div>
                            <button type="submit" onclick="GetPricePageData()" class="btn text-uppercase">اعمال</button>
                        </div>
                        <!--range bottom-->
                    </div>
                    <!--price range-->
                    <!--size filter-->
                    <div class="sidebar_widget">
                        <figure class="img-animi">
                            <a href="#">
                                <img src="~/Content/images/sidebar/sidebar.jpg" alt="" />
                            </a>
                        </figure>
                    </div>
                </div>
                <!--sidebar-->
                <div class="col-md-9 col-sm-9 left-blk dirfloat">                  
                    <div id="nothing" class="dir" style="display:none;"><h2>محصولی برای نمایش وجود ندارد لطفا گروه کالایی دیگری را انتخاب کنید</h2></div>
                    <div class="product-wrap product-listing dir">
                        <div class="sorting-outer">
                            <div class="sorting-wrap">
                                <span class="dir" style="float:right;">مرتب سازی براساس:</span>
                                <ul id="sorting" style="float:right;" class="nav navbar-nav">
                                    <li>پرفروش ترین</li>
                                    <li>جدیدترین</li>
                                    <li>ارزانترین</li>
                                    <li>گرانترین</li>
                                </ul>
                            </div>
                        </div>
                        <div id="load" class="loadajax">
                            <img src="~/Content/images/Loading.gif" alt="" />
                        </div>
                        <ul class="products"></ul>
                    </div>
                    <!--product wrap-->

                    <div class="bottom-sorting">
                        <div class="result-count"></div>
                        <!--result count-->
                        <div class="pagination dir">
                            <ul class="page-numbers"></ul>
                        </div>
                        <!--pegination-->
                    </div>

                    <!--bottom sorting-->
                </div>
                <!--left-->

            </div>
        </div>
    </main>
</div>


<div id="quick-view-popup" data-toggle="modal" data-target="quick-view-popup">
    <div class="qv-wrap">
        <div class="row product">
            <div class="col-md-6 col-sm-6 image pdt-single-slider">
                <div class="product-thumb-slider layout-btm-thumb">
                    <div class="slide-top">
                        <ul class="qv-single-image single-2">
                            <li>
                                <figure><img src="~/Content/images/pdt-single-slide1.jpg" alt=""></figure>
                            </li>

                        </ul>
                    </div>
                    <ul class="qv-single-thumb thumb-2">
                        <li>
                            <figure><img src="~/Content/images/pdt-single-slide6.jpg" alt=""></figure>
                        </li>

                    </ul>
                </div>
            </div>
            <!--slider-->
            
        </div>
    </div>
</div>
<!--quick view-->
<div id="morphsearch" class="morphsearch">
    <div class="morphsearch-content">
        <div class="container">
            <span class="morphsearch-close"></span>
            <form class="morphsearch-form">
                <input class="morphsearch-input" type="search" placeholder="Search..." />
                <button class="morphsearch-submit" type="submit"><i class="pe-7s-search"></i></button>
            </form>
        </div>
    </div><!-- /morphsearch-content -->
</div>
<!--search wrap-->

<a href="#" class="back-to-top"><i class="fa fa-long-arrow-up"></i></a>


<script type="text/javascript">
    var BasketCookie = 'JahanAraShopBasket';
    var BasketCountCooki = 'JahanAraShopBasketCount';
    $(document).ready(function () {
        GetPageData(1,20);

        //search for barnds filter brands
        $("#myInput").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $("#myList li").filter(function() {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });



    });
    //در صورتی که روی یک دکمه کلید شد
    function addtocart(code) {
        if (Cookies.get(BasketCookie) == undefined) {
            //ایجاد یک ارایه جدید
            var arr = [code + ':1'];
            //اضافه کردن آرایه به یک کوکی جدید به شکل جیسون
            Cookies.set(BasketCookie, JSON.stringify(arr));
            //ست کردن تعداد محصولات انتخاب شده در سبد کالا
            Cookies.set(BasketCountCooki, '1');
            jQuery(".BasketCount").html('1');
            jQuery("#btn-Cart").attr("disabled", 'disabled');
            notifyBasket();
        }

        else {

            var json_str = Cookies.get(BasketCookie);
            var arr = JSON.parse(json_str);
            var exist = false; //بررسی اینکه آیا عنصر موردنظر درآرایه وجود دارد یا نه
            for (var i = 0; i < arr.length; i++) {
                if (arr[i].slice(0, arr.indexOf(':') - 1) == code) {
                    jQuery("#btn-Cart").removeClass("actn add-to-cart");
                    //alert('کالا در سبد خرید شما قبلا اضافه شده است..');
                    exist = true;
                    break;
                }
            }
            if (!exist) {

                //اضافه کردن عنصر جد ید ارایه ای که قبلا در کوکی ذخیره شده بود
                arr.push(code + ':1');
                Cookies.set(BasketCookie, JSON.stringify(arr));
                //اضافه کردن یک واحد به تعداد آبتم های داخل سبد کالا
                var ct = parseInt(Cookies.get(BasketCountCooki)) + 1;
                Cookies.set(BasketCountCooki, ct);
                jQuery(".BasketCount").html(ct);
                jQuery("#btn-Cart").attr("disabled", 'disabled');
                notifyBasket();
            }
        }


    };
    function addtowishlist(goodid){

        $.ajax({
            type: 'Post',
            url: '/Product/AddWishList/',
            data: { "GoodID": goodid },
            dataType: "json",
            success: function (data) {

                if (data.isRedirect) {

                    window.location.href = data.redirectUrl;
                }
                else {
                    if (data.result) {
                        notifyWishes();

                    }
                    if (!data.result) {
                        notifyBeforeWishes();
                    }
                }

            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('error: ' + textStatus + ': ' + errorThrown);
            }
        });

    };

    function notifyBasket() {
        $(this).bstooltip('hide');
        $.amaran({
            content: {
                title: 'سبد خرید',
                message: 'با موفقیت به  سبد خرید اضافه شد',
                info: '',
                icon: 'icofont icofont-cart-alt'
            },
            position: 'top right',
            delay: 4000,
            theme: 'awesome ok'

        });
    }
    function notifyWishes() {
        $(this).bstooltip('hide');
        $.amaran({
            content: {
                title: 'لیست علاقه مندی',
                message: 'با موفقیت به لیست علاقه مندی اضافه شد',
                info: '',
                icon: 'icofont icofont-heart-alt'
            },
            position: 'top right',
            delay: 4000,
            theme: 'awesome ok'

        });
    }
    function notifyBeforeWishes() {
        $(this).bstooltip('hide');
        $.amaran({
            content: {
                title: 'لیست علاقه مندی',
                message: 'قبلا به لیست علاقه مندی اضافه شده است',
                info: '',
                icon: 'icofont icofont-heart-alt'
            },
            position: 'top right',
            delay: 4000,
            theme: 'awesome ok'

        });
    }

    var currentPageTemp="";
    var pageSize=20;
    var selectBrandListTemp=[];
    var intselectBrandListTemp =[];
    var MinPrice=0;
    var MaxPrice=0;
    var Sortvalue="";


    $("#sorting li").click(function() {
        $( this ).parent().find('li.active').removeClass('active');
        $(this).addClass('active');
        var name=$(this).addClass('active').html();

        if(name=="پرفروش ترین")
        {
            Sortvalue="BestSelling";
            GetPageData(1,pageSize,intselectBrandListTemp,MinPrice,MaxPrice,Sortvalue);
        }

        if(name=="جدیدترین")
        {
            Sortvalue="Newest";
            GetPageData(1,pageSize,intselectBrandListTemp,MinPrice,MaxPrice,Sortvalue);
        }

        if(name=="ارزانترین")
        {
            Sortvalue="Cheapest";
            GetPageData(1,pageSize,intselectBrandListTemp,MinPrice,MaxPrice,Sortvalue);
        }

        if(name=="گرانترین")
        {
            Sortvalue="Expensive";
            GetPageData(1,pageSize,intselectBrandListTemp,MinPrice,MaxPrice,Sortvalue);
        }

    });

    $("#Group li").click(function() {
        $(this).siblings().removeClass('active');
        $(this).addClass('active');
        var GroupId=parseInt($( this ).parent().find('li.active input').val());
        window.location ='@Url.Action("Categories", "Product")?groupid=' + GroupId ;
    });

    function CheckBrandList() {
        var selectbrandlist = [];
        $('ul.detail-cat').find("input:checkbox:checked").each(function () {
            selectbrandlist.push($(this).val());
        });

        GetPageData(1,20,selectbrandlist,MinPrice,MaxPrice,Sortvalue);
        selectBrandListTemp=selectbrandlist;
        //Convert string array to int array to pass it to Funcation on paging
        intselectBrandListTemp= selectBrandListTemp.map(parseFloat);


    }


    //check if img exists
    function fileExists(fileLocation) {
        var response = $.ajax({
            url: fileLocation,
            type: 'HEAD',
            async: false
        }).status;
        return response;
    }
    var result=false;
    function fileExists(fileLocation) {

         $.ajax({

            type: 'HEAD',
            url: fileLocation,
            async:false,

            success: function() {
                result = true;

            },

            error: function() {

                result = false;
            }

        });

     }



    //Price Filter
    function GetPricePageData()

    {
        MinPrice=parseInt($("#amount1").val().replace(/,/g, ""));
        MaxPrice=parseInt($("#amount2").val().replace(/,/g, ""));
        //var stylemin=$("#amount1").css(left);
        GetPageData(1,pageSize,selectBrandListTemp,MinPrice,MaxPrice,Sortvalue);

    }
    function GetPageData(pageNum, pageSize,brandlist,MinPrice,MaxPrice, sort) {
        if(pageSize==null ) pageSize=20;
        if(MaxPrice==null) MaxPrice=0;
        if(MinPrice==null) MinPrice=0;
        if(sort==null) sort=""
        var proucts = "";
        var GoodType="";

        $.ajax({
            type: 'Post',
            url: '/Home/GetPagingOutLets/',
            data: { "pageNumber": pageNum, "pageSize": pageSize, "ChekedBrands":brandlist, "MinPrice":MinPrice,"MaxPrice":MaxPrice,"Sort":sort},
            dataType: "json",
            beforeSend: function(){
                //load ajax gif
                $('#load').show();
                $('.products').hide();
                $('.bottom-sorting').hide();
            },
            success: function (data) {
                if (!data.result ) {


                    for (var i = 0; i < data.Data.length; i++) {
                        proucts += "<li class='product'>";
                        proucts += "<figure class='img-animi'>";
                        if(data.Data[i].DiscountPercent!=0 )
                        {
                            proucts+= "<div class='tag new'>"+'%'+""+data.Data[i].DiscountPercent+"</div>";
                        }

                        proucts += "<div class='actions trans'>";
                        proucts += "<a class='link-layer' href='#'>&nbsp;</a>";
                        proucts += "<a  class='actn add-to-favorite' data-toggle='tooltip' data-placement='top' onclick='addtowishlist("+data.Data[i].ID+")' title='Add to Wishlist'><i class='pe-7s-like'></i></a>";
                        proucts += "<a  class='actn add-to-cart' data-toggle='tooltip' data-placement='top' onclick='addtocart("+data.Data[i].BarCode+")'  title='Add to Cart'><i class='pe-7s-cart'></i></a>";
                        proucts += "<a  onclick='test()'  class='actn' data-toggle='tooltip' data-placement='top' data-rel='quickview-popup' title='Quick View'><i class='pe-7s-look'></i></a>";
                        proucts += "</div>";
                        var file= "@(JahanAraShop.Application.Resources.Paths.ImageFolder)Products/"+data.Data[i].BarCode+".png";
                       fileExists(file);
                        //if image exists
                        if(result==true)
                        {
                            proucts += "<a href='/Product/Product?GoodID="+data.Data[i].ID+ "'><img src='@(JahanAraShop.Application.Resources.Paths.ImageFolder)Products/"+data.Data[i].BarCode+".png' alt=''></a>";
                        }
                        else
                        {

                            proucts += "<a  href='/Product/Product?GoodID="+data.Data[i].ID+ "'><img src='@(JahanAraShop.Application.Resources.Paths.ImageFolder)Products/defult.png' alt=''></a>";
                        }
                        proucts += "</div>";
                        proucts += "</div>";
                        proucts += "</figure>";
                        proucts += "<div class='price-wrap'>";
                        proucts += "<div class='price'>";

                        var price=data.Data[i].RetailPrice-data.Data[i].DiscountValue;
                        if(data.Data[i].DiscountPercent!=0)
                        {
                            proucts +="<del>" + ReplaceNumberWithCommas(data.Data[i].RetailPrice)+"</del>";
                        }
                        proucts += "<ins>" +"<span style='float:left;'>"+" ریال  "+"</span>"+ ReplaceNumberWithCommas(price) + "</ins>";
                        proucts += "</div>";
                        proucts +="</div>";
                        proucts+= "<div class='star-rate'><i class='fa fa-star'></i><i class='fa fa-star'></i><i class='fa fa-star'></i><i class='fa fa-star'></i><i class='fa fa-star-half-full'></i></div>";
                        proucts += "<h4><a href='#'>" + data.Data[i].Name + "</a></h4>";
                        proucts += "</li>";
                    }

                    $("ul.products").html(proucts);
                    PaggingTemplate(data.TotalPages, data.CurrentPage);

                    for (var i = 0; i < data.GoodTypes.length; i++)
                    {
                        GoodType += "<li> <a href='#'><span class='item-count'>"+data.GoodTypes[i].Name+"</span> <input class='type' onclick='CheckBrandList()' value='"+data.GoodTypes[i].ID+"' type='checkbox'/></a></li>";
                    }
                    $("ul.detail-cat").html(GoodType);

                    //fill rangePrice

                    var rangePrice="<span> از "+ReplaceNumberWithCommas(data.MaxPrice)+" تا "+ReplaceNumberWithCommas(data.MinPrice)+"</span>";
                    $("#amount").html(rangePrice);
                    rangeSlider(data.MinPrice,data.MaxPrice);

                    $('ul.detail-cat').find("input:checkbox").each(function () {

                        for(var i=0;i<selectBrandListTemp.length;i++){
                            var TypeList=$("#myList li").length;
                            for(var j=1;j<=TypeList;j++)
                            {
                                if(data.ChekedBrands[i]==$("#myList li:nth-child("+(j)+")  input").val())
                                {
                                    $("#myList li:nth-child("+(j)+")  input").prop('checked', true);
                                    break;
                                }
                            }
                        }
                    });
                }


                if(data.Data.length==0){

                    $(".product-listing").hide();
                    $(".pagination").hide();
                    $(".result-count").hide();
                    $(".sidebar").hide();
                    $("#nothing").show();
                }

            },
            complete:function(data){
                if(!data.result ){
                    // Hide image container
                    $("#load").hide();
                    $('.products').show();
                    $('.bottom-sorting').show();
                }


            },
            error: function (jqXHR, textStatus, errorThrown) {
                alert('error: ' + textStatus + ': ' + errorThrown);
            }
        });

    }



    ////PriceSlider
    function rangeSlider(Min,Max) {
        $('#price-range').slider({
            range: true,
            min: Min,
            max: Max,
            values: [Min, Max],
            slide: function (event, ui) {
                $('#amount').html("ریال" + ReplaceNumberWithCommas(ui.values[1]) + " - ریال" + ReplaceNumberWithCommas(ui.values[0]));
                $('#amount1').val(ReplaceNumberWithCommas(ui.values[0]));
                $('#amount2').val(ReplaceNumberWithCommas(ui.values[1]));

            }

        });
    }

    //paging template
    function PaggingTemplate(totalPage,currentPage) {
        var template = "";
        var TotalPages = totalPage;
        var CurrentPage = currentPage;
        var PageNumberArray = Array();

        var countIncr = 1;
        for (var i = currentPage; i <= totalPage; i++) {
            PageNumberArray[0] = currentPage;
            if (totalPage != currentPage && PageNumberArray[countIncr - 1] != totalPage) {
                PageNumberArray[countIncr] = i + 1;

            }
            countIncr++;
        };
        PageNumberArray = PageNumberArray.slice(0, 5);
        var FirstPage = 1;
        var LastPAge = totalPage;
        var ForwardOne=TotalPages;
        if (totalPage != currentPage) {
            ForwardOne = currentPage + 1;
        }
        var BackwardOne = 1
        if (currentPage > 1) {
            BackwardOne = currentPage - 1;
        }

        //if no filter price set use defult
        var MinPrice=$("#amount1").val().replace(/,/g, "");
        var MaxPrice=$("#amount2").val().replace(/,/g, "");
        if(MinPrice=="" || MinPrice==null || MinPrice==undefined || MaxPrice=="" ||MaxPrice==null || MaxPrice==undefined)
        {
            MinPrice=0;
            MaxPrice=0;

            var result = "<span >" + TotalPages  + " از  " + CurrentPage + " صفحه </span>"

            if(FirstPage==CurrentPage)
            {
                template += '<li><a class="prev page-numbers" onclick="GetPageData(' + FirstPage + ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')" >&lt;&lt;</a></li>';

            }
            else
            {

                template += '<li><a class="prev page-numbers" onclick="GetPageData(' + FirstPage + ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')" >&lt;&lt;</a></li>';
                template += '<li><a class="prev page-numbers" onclick="GetPageData(' + BackwardOne + ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')" >&lt;</a></li>';
            }

            var numberingLoop = "";

            for (var i = 0; i < PageNumberArray.length; i++) {

                if(PageNumberArray[i]==CurrentPage)
                {
                    numberingLoop = numberingLoop +'<li><a href="#" class="page-numbers current "  onclick="GetPageData('+ PageNumberArray[i] + ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')">' + PageNumberArray[i] + '</a></li>'
                }
                else
                {
                    numberingLoop = numberingLoop +'<li><a href="#" class="page-numbers "  onclick="GetPageData('+ PageNumberArray[i] + ','+pageSize+','+ JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')">' + PageNumberArray[i] + '</a></li>'

                }

            }
            if(ForwardOne!=TotalPages)
            {

                template = template + numberingLoop + '<li><a  class="next page-numbers" onclick="GetPageData(' + ForwardOne + ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')">&gt;</a></li>' +
               '<li><a  class="next page-numbers" onclick="GetPageData(' + LastPAge + ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')">&gt;&gt;</a></li>'
            }
            else
            {

                template = template + numberingLoop +
               '<li><a  class="next page-numbers" onclick="GetPageData(' + LastPAge+ ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')">&gt;&gt;</a></li>'
            }

            $("ul.page-numbers").html(template);
            $(".result-count").html(result);
            currentPageTemp=CurrentPage;



        }

        else
        {
            var result = "<span >" + TotalPages  + " از  " + CurrentPage + " صفحه </span>"

            if(FirstPage==CurrentPage)
            {
                template += '<li><a class="prev page-numbers" onclick="GetPageData(' + FirstPage +','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')" >&lt;&lt;</a></li>';

            }
            else
            {

                template += '<li><a class="prev page-numbers" onclick="GetPageData(' + FirstPage + ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')" >&lt;&lt;</a></li>';
                template += '<li><a class="prev page-numbers" onclick="GetPageData(' + BackwardOne +','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')" >&lt;</a></li>';
            }

            var numberingLoop = "";
            for (var i = 0; i < PageNumberArray.length; i++) {

                if(PageNumberArray[i]==CurrentPage)
                {
                    numberingLoop = numberingLoop +'<li><a href="#" class="page-numbers current "  onclick="GetPageData(' + PageNumberArray[i] + ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')" >' + PageNumberArray[i] + '</a></li>'
                }
                else
                {
                    numberingLoop = numberingLoop +'<li><a href="#" class="page-numbers "  onclick="GetPageData(' + PageNumberArray[i] + ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+','+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')" >' + PageNumberArray[i] + '</a></li>'

                }

            }
            if(ForwardOne!=TotalPages)
            {

                template = template + numberingLoop + '<li><a  class="next page-numbers" onclick="GetPageData(' + ForwardOne +','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')">&gt;</a></li>' +
               '<li><a  class="next page-numbers" onclick="GetPageData(' + LastPAge +','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')">&gt;&gt;</a></li>'
            }
            else
            {

                template = template + numberingLoop +
               '<li><a  class="next page-numbers" onclick="GetPageData(' + LastPAge + ','+pageSize+','+JSON.stringify(intselectBrandListTemp)+' ,'+MinPrice+','+MaxPrice+',\'' +Sortvalue+ '\')">&gt;&gt;</a></li>'
            }

            $("ul.page-numbers").html(template);
            $(".result-count").html(result);
            currentPageTemp=CurrentPage;


        }

    }

    function ReplaceNumberWithCommas(yourNumber)
    {
        if(yourNumber!=null)
        {
            var n = yourNumber.toString().split(".");
            n[0] = n[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return n.join(".");
        }
        else
        {
             return 0;
        }
    }

    function GetProduct()
    {


    }


</script>

